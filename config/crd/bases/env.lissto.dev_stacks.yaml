---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: stacks.env.lissto.dev
spec:
  group: env.lissto.dev
  names:
    kind: Stack
    listKind: StackList
    plural: stacks
    singular: stack
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Stack is the Schema for the stacks API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: spec defines the desired state of Stack
            properties:
              blueprintReference:
                description: |-
                  BlueprintReference references the Blueprint resource
                  This field is immutable after creation
                type: string
                x-kubernetes-validations:
                - message: blueprintReference is immutable after creation
                  rule: self == oldSelf
              env:
                description: |-
                  Env references the Env resource
                  This field is immutable after creation
                type: string
                x-kubernetes-validations:
                - message: env is immutable after creation
                  rule: self == oldSelf
              images:
                additionalProperties:
                  description: ImageInfo contains information about a resolved image
                  properties:
                    containerName:
                      description: |-
                        ContainerName is the custom container name if specified in docker-compose
                        If empty, defaults to service name for matching
                      type: string
                    digest:
                      description: Digest is the full image digest (e.g., sha256:abc123...)
                      type: string
                    image:
                      description: Image is the user-friendly image tag that was resolved
                        (e.g., myimage:v1.2.3)
                      type: string
                    url:
                      description: URL is the exposed service URL (if the service
                        is exposed)
                      type: string
                  required:
                  - digest
                  type: object
                description: |-
                  Images contains the service to image information mapping
                  This is the only mutable field - updates trigger rolling deployments
                type: object
              manifestsConfigMapRef:
                description: |-
                  ManifestsConfigMapRef references the ConfigMap containing the generated Kubernetes YAML manifests
                  This field is immutable after creation
                type: string
                x-kubernetes-validations:
                - message: manifestsConfigMapRef is immutable after creation
                  rule: self == oldSelf
              metadata:
                description: |-
                  Metadata contains stack creation metadata
                  This field is mutable and can be updated to track image sources
                properties:
                  author:
                    description: Author who created the stack
                    type: string
                  branch:
                    description: Branch used for image resolution
                    type: string
                  commit:
                    description: Commit hash used for image resolution
                    type: string
                  tag:
                    description: Tag used for image resolution
                    type: string
                type: object
              restore:
                description: |-
                  Restore configures restoration from a StackSnapshot
                  Used when creating a stack from a snapshot backup
                properties:
                  exclude:
                    description: Exclude specific resources from restore (for migration
                      scenarios)
                    items:
                      description: ResourceRef identifies a specific Kubernetes resource
                        by kind and name
                      properties:
                        kind:
                          description: Kind of the resource (e.g., PersistentVolumeClaim,
                            ConfigMap, Secret)
                          type: string
                        name:
                          description: Name of the resource
                          type: string
                      required:
                      - kind
                      - name
                      type: object
                    type: array
                  include:
                    description: Include only specific resources (whitelist mode,
                      overrides exclude)
                    items:
                      description: ResourceRef identifies a specific Kubernetes resource
                        by kind and name
                      properties:
                        kind:
                          description: Kind of the resource (e.g., PersistentVolumeClaim,
                            ConfigMap, Secret)
                          type: string
                        name:
                          description: Name of the resource
                          type: string
                      required:
                      - kind
                      - name
                      type: object
                    type: array
                  snapshotRef:
                    description: SnapshotRef is the name of the StackSnapshot to restore
                      from
                    type: string
                required:
                - snapshotRef
                type: object
              suspension:
                description: |-
                  Suspension controls which services are suspended
                  When services are suspended, their workload resources are deleted
                  while state resources (lissto.dev/class: state) are preserved
                properties:
                  services:
                    description: |-
                      Services to suspend. Use ["*"] to suspend all services.
                      Empty or omitted means no suspension.
                    items:
                      type: string
                    type: array
                  timeout:
                    description: |-
                      Timeout for workload termination when suspending
                      Defaults to controller config stack.defaultSuspendTimeout (default: 5m)
                    type: string
                type: object
            required:
            - blueprintReference
            - env
            - images
            type: object
          status:
            description: status defines the observed state of Stack
            properties:
              conditions:
                description: |-
                  Conditions track the status of each resource and overall stack state
                  - Type="Ready": Overall stack readiness (Status=True/False)
                  - Type="Resource/{Kind}/{Name}": Individual resource status
                    Status=True (applied successfully), False (failed)
                    Reason="Applied" or "Failed"
                    Message contains error details if failed
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              observedGeneration:
                description: |-
                  ObservedGeneration is the generation of the Stack that was most recently reconciled
                  If this differs from metadata.generation, the spec has changed but hasn't been reconciled yet
                format: int64
                type: integer
              phase:
                description: Phase indicates the current lifecycle phase of the Stack
                type: string
              phaseHistory:
                description: PhaseHistory tracks recent phase transitions (last 10)
                items:
                  description: PhaseTransition records a phase change in the stack
                    lifecycle
                  properties:
                    message:
                      description: Message is a human-readable description
                      type: string
                    phase:
                      description: Phase that was transitioned to
                      type: string
                    reason:
                      description: Reason is a machine-readable reason for the transition
                      type: string
                    transitionTime:
                      description: TransitionTime is when the transition occurred
                      format: date-time
                      type: string
                  required:
                  - phase
                  - transitionTime
                  type: object
                type: array
                x-kubernetes-list-type: atomic
              restoreStatus:
                description: |-
                  RestoreStatus tracks the progress of a restore operation
                  Only present if spec.restore was specified
                properties:
                  completedAt:
                    description: CompletedAt is when the restore operation completed
                    format: date-time
                    type: string
                  error:
                    description: Error message if restore failed
                    type: string
                  phase:
                    description: Phase of the restore operation
                    type: string
                  restoredResources:
                    description: RestoredResources lists resources that were restored
                    items:
                      description: ResourceRef identifies a specific Kubernetes resource
                        by kind and name
                      properties:
                        kind:
                          description: Kind of the resource (e.g., PersistentVolumeClaim,
                            ConfigMap, Secret)
                          type: string
                        name:
                          description: Name of the resource
                          type: string
                      required:
                      - kind
                      - name
                      type: object
                    type: array
                  snapshotRef:
                    description: SnapshotRef is the name of the StackSnapshot being
                      restored from
                    type: string
                  startedAt:
                    description: StartedAt is when the restore operation started
                    format: date-time
                    type: string
                required:
                - phase
                - snapshotRef
                type: object
              services:
                additionalProperties:
                  description: ServiceStatus tracks the status of a single service
                    within the stack
                  properties:
                    phase:
                      description: Phase is the current phase of this service
                      type: string
                    suspendedAt:
                      description: SuspendedAt is when the service was suspended (nil
                        if running)
                      format: date-time
                      type: string
                  required:
                  - phase
                  type: object
                description: Services contains per-service status information
                type: object
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
