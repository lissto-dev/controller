# ValidatingAdmissionPolicy to prevent race conditions during stack phase transitions
# Requires Kubernetes 1.28+ (ValidatingAdmissionPolicy GA in 1.30+)
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicy
metadata:
  name: stack-transition-lock
spec:
  failurePolicy: Fail
  matchConstraints:
    resourceRules:
      - apiGroups: ["env.lissto.dev"]
        apiVersions: ["v1alpha1"]
        resources: ["stacks"]
        operations: ["UPDATE"]
  validations:
    # Block suspension.services changes during Suspending phase
    - expression: >
        !has(oldObject.status) || 
        !has(oldObject.status.phase) ||
        oldObject.status.phase != 'Suspending' || 
        ((!has(object.spec.suspension) || !has(object.spec.suspension.services)) && 
         (!has(oldObject.spec.suspension) || !has(oldObject.spec.suspension.services))) ||
        (has(object.spec.suspension) && has(object.spec.suspension.services) &&
         has(oldObject.spec.suspension) && has(oldObject.spec.suspension.services) &&
         object.spec.suspension.services == oldObject.spec.suspension.services)
      message: "cannot change 'suspension.services' while stack is Suspending"
    # Block suspension.services changes during Resuming phase
    - expression: >
        !has(oldObject.status) ||
        !has(oldObject.status.phase) ||
        oldObject.status.phase != 'Resuming' || 
        ((!has(object.spec.suspension) || !has(object.spec.suspension.services)) && 
         (!has(oldObject.spec.suspension) || !has(oldObject.spec.suspension.services))) ||
        (has(object.spec.suspension) && has(object.spec.suspension.services) &&
         has(oldObject.spec.suspension) && has(oldObject.spec.suspension.services) &&
         object.spec.suspension.services == oldObject.spec.suspension.services)
      message: "cannot change 'suspension.services' while stack is Resuming"
---
apiVersion: admissionregistration.k8s.io/v1
kind: ValidatingAdmissionPolicyBinding
metadata:
  name: stack-transition-lock-binding
spec:
  policyName: stack-transition-lock
  validationActions: [Deny]
  matchResources: {}
